---
title: "Plots for workflow figure using a mock example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plots for new figure 1}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

To create the mock datelife example for the workflow figure of the manuscript, we used the real data from the small example.


## Getting source chronograms

```{r setup}
getwd()
devtools::load_all("../../datelifeplot")
# devtools::load_all("../../datelife")
devtools::install_github(repo = "phylotastic/datelife")
load("../data/frin_sample_dsumm.rda")
frin_sample_dsumm$phylo_median
spp <- frin_sample_dsumm$phylo_median$tip.label[1:6]
spp_tree <- ape::drop.tip(phy = frin_sample_dsumm$phylo_median, tip = frin_sample_dsumm$phylo_median$tip.label[-(1:6)])
spp_dq <- datelife::make_datelife_query(spp)
spp_dq$phy <- spp_tree
spp_dr <- datelife::get_datelife_result(spp_dq)
```

There is one chronogram that has inconsistent ages for one node relative to other node ages. It is Study 6, Burns et al.
To produce a figure that would showcase the datelife workflow in a clear and straightforward way, we decided to keep only 3 source chronograms:

Study 1, and
Study 3 - Chronogram 1 and 2.

These studies correspond to indices 1, 4 and 5 from the datelife result, so we are going to prune those out:

```{r}
spp_dr_fig1 <- spp_dr[c(1,4,5)]
names(spp_dr_fig1)
names(spp_dr)[c(1,4,5)] == names(spp_dr_fig1)
```


```{r}
class(spp_dr_fig1) <- "datelifeResult"
spp_summ <- datelife:::summary.datelifeResult(datelife_query = spp_dq, object = spp_dr_fig1)
```

```{r}
  datelife_query = spp_dq
	datelife_result <- spp_dr_fig1
	mrcas <- datelife:::datelife_result_MRCA(datelife_result, na_rm = TRUE)
	newick_all <- datelife:::datelife_result_newick_all(datelife_result, na_rm = TRUE)
	phylo_all <- datelife:::datelife_result_phylo_all(datelife_result, na_rm = TRUE)
	biggest <- datelife:::get_biggest_multiphylo(phylo_all) # NAs in trees are removed in get_biggest_multiphylo

	median_and_sdm <- datelife:::datelife_result_median_and_sdm(datelife_result, datelife_query, na_rm = na_rm)
####	
	best_grove <- datelife::get_best_grove(datelife_result, criterion = "taxa", n = 2)$best_grove
  target_tree <- datelife_query$phy
###
  median_phylo <- datelife::datelife_result_median(best_grove, target_tree = target_tree)
###
  median_matrix <- datelife::datelife_result_median_matrix(datelife_result)
```

```{r eval = FALSE}
phy <- datelife::summary_matrix_to_phylo(median_matrix, use = "median")

###
check_ott_input(input, ott_ids)  

```

```{r}
phy <- datelife::summary_matrix_to_phylo(median_matrix, use = "median", target_tree = target_tree)
phy
```



```{r}
spp_summ$phylo_all

mock_spp_names <- gsub(" ", "_", spp_summ$phylo_median$tip.label)
names(mock_spp_names) <- LETTERS[1:6]
mock_spp_names

mock_study_names <- names(spp_summ$phylo_all)
iis <- match(mock_study_names, unique(mock_study_names))
names(mock_study_names) <- paste("Study", iis)
names(mock_study_names)
ffs <- table(names(mock_study_names))

is_dupl <- names(mock_study_names) %in% names(ffs)[ffs > 1]

# Add "Chronogram X" to duplicated studies:

for (i in names(ffs)[ffs > 1]) {
  dds <- i == names(mock_study_names)
  chrono_names <- paste("- Chronogram", seq(ffs[[i]]))
  names(mock_study_names)[dds] <- paste(names(mock_study_names)[dds],chrono_names )
}
```

### Rename source chronograms:

```{r}
phylo_all_renamed <- c()
for (phy in spp_summ$phylo_all){
  is_in_tree <- match(gsub(" ", "_", phy$tip.label), mock_spp_names)
  phy$tip.label <- names(mock_spp_names)[is_in_tree]
  phylo_all_renamed <- c(phylo_all_renamed, list(phy))
}
class(phylo_all_renamed) <- "multiPhylo"
names(phylo_all_renamed) <- names(mock_study_names)
```

### Plotting ALL source chronograms

I combined source chronogram plots with ppt.
```{r eval = FALSE}
# as pdf:
plot_max_time <- 30
datelifeplot::plot_phylo_all(chronograms = phylo_all_renamed,
                             write = "pdf",
                             folder_name = "../figures/figure-workflow/source_chronograms",
                             file_name = "phylo_all",
                             plot_type = "phyloch",
                             max_depth = plot_max_time,
                             edge.width = 3,
                             cex_tiplabels = 2,
                             cex_axislabel = 1.5,
                             cex_axis = 2,
                             cex_title = 2.5,
                             pos_title = 3,
                             pos_axis = 2,
                             axis_label = "",
                             units = NULL,
                             plot_height = 250,
                             plot_width = 5)
```
## Get calibrations

Rename median chronogram tip labels:

```{r}
phylo_median <- spp_summ$phylo_median
is_in_tree <- match(gsub(" ", "_", phylo_median$tip.label), mock_spp_names)
phylo_median$tip.label <- names(mock_spp_names)[is_in_tree]
```

Save as newick:

```{r eval = FALSE}
ape::write.tree(phylo_median, file = "../figures/figure-workflow/median_chronogram.tre")
```

Get calibrations:

```{r}
devtools::load_all("../../lunasare/datelife")
all_calibrations <- datelife::extract_calibrations_phylo(input = phylo_all_renamed,
                                                         each = FALSE)
small_phylo_all <- phylo_all_renamed
#phylo_median <- read.tree(file = "../figures/figure-workflow/median_chronogram.tre")
small_phylo_median <- phylo_median
matched <- datelife:::match_all_calibrations(
  phy = phylo_median, 
  calibrations = all_calibrations)
small_matched <- matched
calib_summ <- datelife:::summary.matchedCalibrations(
  matched$matched_calibrations)
if (all(calib_summ$in_phy$minAge == calib_summ$in_phy$maxAge)) {
  calib_summ$in_phy$nodeAge <- calib_summ$in_phy$MinAge
}
ls(calib_summ$in_phy)
small_calib_summ <- calib_summ
# usethis::use_data(small_calib_summ, overwrite = TRUE)
# usethis::use_data(small_phylo_all)
# usethis::use_data(small_matched)
# usethis::use_data(small_phylo_median)
```
## Phylo median tree as a phylogram (all branches equal length)

```{r}
# visualize median branching times:
ape::branching.times(phylo_median)
# force equal branch lengths, with root age = 1
pp <- ape::compute.brlen(phylo_median, power = 1)
# visualize the new branch lengths:
ape::branching.times(pp)
pp$edge.length
plot(pp)
ape::axisPhylo(side = 1)
# to make branch lengths proportional to a certain age we have to multiply them by that age, in this case it's the total plot_max_time
pp$edge.length <- pp$edge.length*45 
# I decided to make the two oldest branches shorter:
pp$edge.length[pp$edge.length == 27] <- 9
```

Plot ages from source chronograms on top of opentree synth tree:

```{r}
# Get references in matched calibrations:
studies <- as.character(unique(calib_summ$in_phy$reference))
# order references alphabetically:
studies <- studies[order(studies)]
```

```{r}
#create a vector of colors with study names:
color_studies <- viridis::turbo(n = 9)
color_studies
```

visualize colors sampled form viridis turbo:
```{r}
c1 <- "#30123BFF" 
c2 <- "#466BE3FF" 
c3 <- "#28BBECFF" 
c4 <- "#31F299FF" 
c5 <- "#A2FC3CFF" 
c6 <- "#EDD03AFF" 
c7 <- "#FB8022FF" 
c8 <- "#D23105FF"
c9 <- "#7A0403FF"
```

Plot of source ages against an opentree topology:
```{r}
color_studies <- c(c2, c8, c4)
names(color_studies) <- studies

plot_max_time <- 30

svg(filename = "../figures/figure-workflow/opentree_source_ages.svg",
    height = 5,
    width = 5)
datelifeplot::plot_node_ages(pp,
               title = c(""),
               cex_title = 2,
               plot_type = "phyloch",
               time_depth = plot_max_time,
               pos_axis = 2,
               cex_axis = 1.3,
               edge.width = 3,
               cex_tiplabels = 2,
               calibration_summary = calib_summ,
               pch = 18,
               color_pch = color_studies,
               cex_pch =  2,
               lwd_bars = 10,
               cex_legend = 1,
               axis_label = "",
               x_legend = 0,
               y_legend = 7.5,
               mai2 = 0
               )
ape::nodelabels(text = pp$node.label, frame = "circle", bg = "white")
dev.off()
```

## Plot OpenTree tree topology with node labels and no time axis

```{r}
plot_max_time <- 30
svg(filename = "../figures/figure-workflow/opentree_topology.svg",
#pdf(file = "../figures/figure-workflow/opentree_topology.pdf",
#png(filename = "../figures/figure-workflow/opentree_topology.png",
    height = 5,
    width = 5,
    bg = "transparent")
datelifeplot::plot_chronogram(pp,
                         title = c(""),
                         time_depth = plot_max_time,
                         time_axis = FALSE,
                         axis_label = "",
                         edge.width = 3,
                         cex_tiplabels = 2,
                         cex_axislabel = 1.5,
                         cex_axis = 2,
                         cex_title = 1.5,
                         pos_title = 2
                             )
ape::nodelabels(text = pp$node.label, frame = "circle", bg = "white", cex = 1.5)
dev.off()
```


## Get pairwise median age points and plot them:

```{r} 
names(spp_dr_fig1)
spp_dr_fig1[[1]]

best_grove <- datelife::get_best_grove(spp_dr_fig1)

median_matrix <- datelife::datelife_result_median_matrix(best_grove$best_grove)
colnames(median_matrix)

median_matrix_list <- list(summary_matrix = median_matrix)

median_matrix_table <- datelife::matrices_to_table(median_matrix_list)

matched_median_ages <- datelife:::match_all_calibrations(phy = spp_summ$phylo_median, calibrations = median_matrix_table)

mm_summ <- datelife:::summary.matchedCalibrations(matched_median_ages$matched_calibrations)
```

```{r}
mm_summ$in_phy

## rename

mm_summ$in_phy$taxonA

is_in_taxonA <- match(gsub(" ", "_", mm_summ$in_phy$taxonA), mock_spp_names)
mm_summ$in_phy$taxonA <- names(mock_spp_names)[is_in_taxonA]

is_in_taxonB <- match(gsub(" ", "_", mm_summ$in_phy$taxonB), mock_spp_names)
mm_summ$in_phy$taxonB <- names(mock_spp_names)[is_in_taxonB]
```


Table:

```{r}
colnames(mm_summ$in_phy)
pretty <- mm_summ$in_phy[,c("taxonA", "taxonB", "nodeAge", "mrca_node_number")]
pretty
# Eliminate duplicated taxon pairs:
## Find the duplicated pairs
taxon_pairs <- c()
for (i in seq(nrow(pretty))) {
  taxon_pair <- as.character(pretty[i, c("taxonA", "taxonB")])
  taxon_pair <- taxon_pair[order(taxon_pair)]
  taxon_pair <- paste(taxon_pair, collapse = "")
  taxon_pairs <- c(taxon_pairs, taxon_pair)
}
## Eliminate them:
pretty <- pretty[!duplicated(taxon_pairs),]

# Reorder ROWS by node number and taxon names
pretty <- pretty[order(pretty$mrca_node_number, pretty$taxonA, pretty$taxonB),]
# Eliminate rownames
rownames(pretty) <- NULL
# Reorder COLUMNS
pretty <- pretty[, c("mrca_node_number", "taxonA", "taxonB", "nodeAge")]
# Modify column names to be informative
colnames(pretty)[4] <- "Median Pairwise Age"
colnames(pretty)[1] <- "Node Name"
# Change node numbers my node names
pretty$`Node Name` <- paste0("n", pretty$`Node Name`-6)
write.csv(pretty, file = "../figures/figure-workflow/median_table.csv")
```

```{r}
# Print table as pdf
pdf("../figures/figure-workflow/median_table.pdf")       # Export PDF
gridExtra::grid.table(pretty) # if you do not want row numbers set rows = NULL
dev.off()
```

### Summary table

```{r, error = TRUE}
library(dplyr)
colnames(pretty)[1] <- "NodeName"
?group_by
pretty %>% 
  group_by(NodeName) -> pretty_group

summarize(pretty_group, abundance = summary())
```

```{r}
colnames(pretty)[1] <- "Node Name"

res <- matrix(nrow = length(unique(pretty$`Node Name`)), ncol = 7)

for (i in 1:length(unique(pretty$`Node Name`))) {
  rowsies <- pretty$`Node Name` == unique(pretty$`Node Name`)[i]
  summi <- summary(pretty$`Median Pairwise Age`[rowsies])
  res[i, 1:6] <- summi
  res[i, 7] <- sd(pretty$`Median Pairwise Age`[rowsies])
}
summary_table <- as.data.frame(res)

summary_table$Node <- unique(pretty$`Node Name`)
colnames(summary_table) <- c(names(summi), "SD", "Node Name")

summary_table <- summary_table[, c(8, 1:7)]

write.csv(summary_table, file = "../figures/figure-workflow/summary_table.csv")
# Export PDF
pdf("../figures/figure-workflow/summary_table.pdf", height = 2)       
gridExtra::grid.table(summary_table, rows = NULL) # if you do not want row numbers set rows = NULL
dev.off()

pdf("../figures/figure-workflow/summary_table_reduced.pdf", height = 2)       
gridExtra::grid.table(summary_table[, c("Node Name", "Min.", "Median", "Max.", "SD")], rows = NULL) # if you do not want row numbers set rows = NULL
dev.off()
```



## Median chronogram

```{r}
color_median <- color_studies[6] # mustard yellow

mm_summ$in_phy$reference <- rep("Median pairwise \nnode ages", 
                                nrow(mm_summ$in_phy))
length(unique(mm_summ$in_phy$nodeAge))
# there are 8 different median pairwise ages

mm_summ$in_phy[, c("mrca_node_name", "nodeAge")]

color_median
names(color_median) <- mm_summ$in_phy$reference[1]

svg(filename = "../figures/figure-workflow/median_ages.svg",
    height = 5,
    width = 5.5)
datelifeplot::plot_node_ages(phylo_median,
               title = c("Median Summary Chronogram"),
               pos_title = 3,
               cex_title = 2,
               plot_type = "phyloch",
               time_depth = plot_max_time,
               pos_axis = 2,
               cex_axis = 1.3,
               edge.width = 3,
               cex_tiplabels = 2,
               calibration_summary  = mm_summ,
               pch = "X",
               color_pch =  color_median,
               cex_pch = 2,
               lwd_bars = 15,
               cex_legend =1.4,
               x_legend = 0,
               y_legend = 7,
               mai2 = 0,
               axis_label = "",
               legend_box = FALSE
               )
dev.off()
```
             
# SDM tree

```{r}
phylo_sdm <- spp_summ$phylo_sdm
is_in_tree <- match(gsub(" ", "_", phylo_sdm$tip.label), mock_spp_names)
phylo_sdm$tip.label <- names(mock_spp_names)[is_in_tree]

best_grove <- datelife::get_best_grove(spp_dr_fig1)

sdm_matrix <- datelife::datelife_result_sdm_matrix(best_grove$best_grove)
colnames(sdm_matrix)

sdm_matrix_list <- list(summary_matrix = sdm_matrix)

sdm_matrix_table <- datelife::matrices_to_table(sdm_matrix_list)

matched_sdm_ages <- datelife::match_all_calibrations(phy = spp_summ$phylo_sdm, calibrations = sdm_matrix_table)

sdm_summ <- datelife:::summary.matchedCalibrations(matched_sdm_ages$matched_calibrations)

sdm_summ$in_phy

## rename

sdm_summ$in_phy$taxonA

is_in_taxonA <- match(gsub(" ", "_", sdm_summ$in_phy$taxonA), mock_spp_names)
mm_summ$in_phy$taxonA <- names(mock_spp_names)[is_in_taxonA]

is_in_taxonB <- match(gsub(" ", "_", sdm_summ$in_phy$taxonB), mock_spp_names)
mm_summ$in_phy$taxonB <- names(mock_spp_names)[is_in_taxonB]
```


Plot:

```{r}
color_reference <- "purple"

sdm_summ$in_phy$reference <- rep("SDM pairwise \nnode ages\n", nrow(sdm_summ$in_phy))

names(color_reference) <- c("SDM pairwise \nnode ages\n")

svg(filename = "../figures/figure-workflow/sdm_ages.svg",
    height = 5,
    width = 7)
datelifeplot::plot_node_ages(phylo_sdm,
               title = c("SDM Summary Chronogram"),
               cex_title = 2,
               plot_type = "phyloch",
               time_depth = plot_max_time,
               pos_axis = 2,
               cex_axis = 1.3,
               edge.width = 3,
               cex_tiplabels = 2,
               calibration_summary = sdm_summ,
               pch = "|",
               color_pch = color_reference,
               cex_pch = 2,
               lwd_bars = 15,
               cex_legend = 1.5,
               x_legend = 0,
               y_legend = 6
               )
dev.off()
```


Plotting source ages AND summary ages on the same dated tree

Developed for new workflow figure (file figure1-new-horizontal.pdf)

```{r}
# summary_table <- read.csv(file = "../figures/figure-workflow/summary_table.csv")
# TODO: need to actually summarize mm_summ$in_phy per node
mm_summ$in_phy
rr <- !duplicated(mm_summ$in_phy$mrca_node_number)
mm_summ$in_phy <- mm_summ$in_phy[rr,]
mm_summ$in_phy$reference <- NULL
mm_summ$in_phy$reference <- "Used as calibrations"
```

Set parameters for plotting:
```{r}
color_median <- "purple"
names(color_median) <- as.vector(unique(mm_summ$in_phy$reference)) 
point_colors <- list(a1 = color_studies, a2 = color_median)
small_all_ages <- list(a1 = small_calib_summ, a2 = mm_summ)
point_type <- list(a1 = "•", a2 = "/")
point_cex <- list(a1 =  3.5, a2 = 2.5)
plot_max_time <- 30
leg_title <- c("Taxon pair node ages \nfrom source chronograms", "Median of node ages")
leg_box <- c(TRUE, TRUE)
leg_pt_cex <- list(a1 = 1.7, a2 = 1)
```

```{r}
# devtools::load_all(path = "../../datelifeplot")
# source("../R/plot_node_ages_v2.2.R")
svg(filename = "../figures/figure-workflow/all_ages.svg",
    height = 4,
    width = 6)
plot_node_ages_2.2(chronogram = small_phylo_median,
                   title = c("Median Summary Chronogram"),
                   matched_ages  = small_all_ages,
                   pos_title = 3,
                   cex_title = 2,
                   plot_type = "phyloch",
                   time_depth = plot_max_time,
                   cex_axis = 1.3,
                   edge_width = 2,
                   label.offset = 0.5,
                   cex_tiplabels = 1.8,
                   pch_type = point_type, 
                   pch_color = point_colors,
                   pch_cex = point_cex,
                   bars_lwd = 15,
                   legend_cex = 0.6,
                   legend_pt_cex = leg_pt_cex,
                   legend_x = c(2, 2.5),
                   legend_y = c(3.4, 1.7 ),
                   legend_title = leg_title,
                   legend_box = leg_box,
                   cex_axislabel = 1,
                   axis_label = "",
                   mai1 = 0 , mai2 = 0.3, mai3 = 0.3, mai4 = 0.3,
                   omi1 = 1, omi2 = 0.3, omi3 = 0.3, omi4 = 0.3
                  )
dev.off()
```


