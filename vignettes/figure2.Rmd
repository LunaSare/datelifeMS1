---
title: "figure2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{figure2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Getting source chronograms

```{r setup}
# library(datelifeMS1)
devtools::load_all("../../datelifeplot")
devtools::load_all()
frin_sample_dsumm$phylo_median
spp <- frin_sample_dsumm$phylo_median$tip.label[1:6]
spp_dq <- datelife::make_datelife_query(spp)
spp_dr <- datelife::get_datelife_result(spp_dq)
spp_summ <- datelife:::summary.datelifeResult(datelife_query = spp_dq, object = spp_dr)
phylo_median <- spp_summ$phylo_median
phylo_all <- spp_summ$phylo_all
names(phylo_all)
```

We will rename source chronograms to have a shorter study name:

```{r}
names(phylo_all) <- c("Hooper et al. 2017",
                      "Hedges et al. 2015",
                      "Hedges et al. 2015",
                      "Barker et al. 2015",
                      "Barker et al. 2015",
                      "Jetz et al. 2012",
                      "Jetz et al. 2012",
                      "Barker et al. 2013",
                      "Burns et al. 2014")
```

### Plotting chronograms

Plot one chronogram as test:

```{r}
plot_max_time <- 45
chronogram <- phylo_all[[1]]
chronogram$root.edge <- plot_max_time - max(ape::branching.times(chronogram))

ape::plot.phylo(chronogram,
                cex = 1, #edge.width = 2,
                label.offset = 0.5,
                x.lim = c(0, plot_max_time),
                root.edge = TRUE,
                plot = TRUE, edge.width = 2)
ape::axisPhylo(line = 1)

datelifeplot::plot_phylo(chronogram,
                         title = names(phylo_all)[1],
                         plot_type = "ape",
                         time_depth = plot_max_time,
                         write = "pdf",
                         file_name = "../figures/figure2/test.pdf",
                         cex_tiplabels = 2,
                         cex_axislabel = 1.5,
                         cex_title = 2,
                         pos_title = 2.2,
                         pos_axis = 2)
```
[!Source chronogram test]("../figures/figure2/test.pdf")


### Plotting ALL source chronograms

We know that chronogram 9 has the oldest ages.
Get the maximum age:
```{r}
max(ape::branching.times(phylo_all[[9]]))  # 44.29586
plot_max_time <- 45
# as pdf:
datelifeplot::plot_phylo_all(chronograms = phylo_all,
                             folder_name = "../figures/figure2/source_phylo_all",
                             plot_height = 600,
                             plot_width = 600,
                             mai1 = 1,
                             mai2 = 0,
                             mai3 = 1,
                             mai4 = 2.8,
                             omi1 = 2,
                             omi2 = 0,
                             omi3 = 1,
                             omi4 = 0,
                             write = "pdf",
                             plot_type = "phyloch",
                             max_depth = plot_max_time,
                             edge.width = 2,
                             cex_tiplabels = 1.5,
                             cex_axislabel = 1.5,
                             cex_axis = 2,
                             cex_title = 2,
                             pos_title = -2.8,
                             pos_axis = 2,
                             units = NULL)
```


I combined source chronogram plots with ppt because combining with `magick` was not
doing what I needed. This is the code I tried:

```{r}
for (i in seq(phylo_all_renamed)) {
  ii <- magick::image_read(path = paste0("phylo_all/phylo_all_", i, ".pdf"))
  assign(x = paste0("phy", i), value = ii)
}
img <- c(phy1, phy2, phy3, phy4, phy5, phy6, phy7, phy8, phy9)
img <- magick::image_scale(img, "300x")
magick::image_info(img)

pdf("stacked.pdf")
magick::image_append(magick::image_scale(img, "200x"))
dev.off()
```

## Get calibrations

Get calibrations:

```{r}
all_calibrations <- datelife::extract_calibrations_phylo(
  input = phylo_all,
  each = FALSE)
matched <- datelife::match_all_calibrations(
  phy = phylo_median, 
  calibrations = all_calibrations)
calib_summ <- datelife:::summary.matchedCalibrations(
  matched$matched_calibrations)

```
Plot ages from source chronograms.
Choose a color scheme for the studies:

```{r}
# Get references in matched calibrations:
studies <- as.character(unique(calib_summ$in_phy$reference))
studies

# order references alphabetically:
studies <- studies[order(studies)]
#create a vector of colors with study names:
color_studies <- viridis::turbo(n = length(studies))
names(color_studies) <- studies
```

Now, we can plot:

```{r}
svg(filename = "../figures/figure2/node_ages_matched.svg",
    height = 10,
    width = 7)
datelifeplot::plot_node_ages(phylo_median,
               title = "Median Summary Chronogram",
               plot_type = "phyloch",
               time_depth = plot_max_time,
               calibration_summary = calib_summ,
               pch = 19,
               color_pch = color_studies,
               cex_pch = 2,
               lwd_bars = 15,
               cex_legend = 0.7,
               x_legend = 2,
               y_legend = 6,
               mai1 = 1, 
               mai2 = 0,
               mai3 = 0.5,
               mai4 = 2.8,
               omi1 = 2,
               omi2 = 0,
               omi3 = 0.5,
               omi4 = 0,
               edge.width = 2,
               cex_tiplabels = 1.5,
               cex_axislabel = 1.5,
               cex_axis = 2,
               cex_title = 1.2,
               pos_title = -1,
               pos_axis = 2
               )
dev.off()
```
## Get pairwise median age points and plot them:

```{r}

names(spp_dr)
spp_dr[[1]]

best_grove <- datelife::get_best_grove(spp_dr)

median_matrix <- datelife::datelife_result_median_matrix(best_grove$best_grove)
colnames(median_matrix)

median_matrix_list <- list(summary_matrix = median_matrix)

median_matrix_table <- datelife::matrices_to_table(median_matrix_list)

matched_median_ages <- datelife::match_all_calibrations(phy = spp_summ$phylo_median, calibrations = median_matrix_table)

mm_summ <- datelife:::summary.matchedCalibrations(matched_median_ages$matched_calibrations)

mm_summ$in_phy

## rename

mm_summ$in_phy$taxonA

is_in_taxonA <- match(gsub(" ", "_", mm_summ$in_phy$taxonA), mock_spp_names)
mm_summ$in_phy$taxonA <- names(mock_spp_names)[is_in_taxonA]

is_in_taxonB <- match(gsub(" ", "_", mm_summ$in_phy$taxonB), mock_spp_names)
mm_summ$in_phy$taxonB <- names(mock_spp_names)[is_in_taxonB]

mm_summ$in_phy$reference <- rep("Used as calibration", nrow(mm_summ$in_phy))

AB <- mm_summ$in_phy$taxonA %in% c("A", "B") & mm_summ$in_phy$taxonB %in% c("A", "B")

AC <- mm_summ$in_phy$taxonA %in% c("A", "C") & mm_summ$in_phy$taxonB %in% c("A", "C")

not_used <- AB | AC

mm_summ$in_phy[not_used,]

mm_summ$in_phy[not_used,]$reference <- rep("Excluded from analysis", 4)
```



```{r}
# We have two variables, median ages "used" as calibrations, and median ages "not used" or "excluded from analysis".
color_reference <- viridis::viridis(2) 
# c("blue", "gray")
names(color_reference) <- c("Used as calibration", "Excluded from analysis")
datelifeplot::plot_node_ages(phylo_median,
               title = c("Median Summary Chronogram", "with median pairwise ages"),
               plot_type = "phyloch",
               time_depth = plot_max_time,
               pos_axis = 2,
               edge.width = 2,
               calibration_summary = mm_summ,
               pch = 19,
               color_pch = color_reference,
               transparent_pch = 70,
               add_legend = TRUE,
               cex_legend = 0.5
               )

svg(filename = "../figures/figure2/median_ages.svg",
    height = 5,
    width = 7)
datelifeplot::plot_node_ages(phylo_median,
               title = c("Median Summary Chronogram", "with median pairwise ages"),
               cex_title = 2,
               plot_type = "phyloch",
               time_depth = plot_max_time,
               pos_axis = 2,
               edge.width = 2,
               cex_tiplabels = 2,
               calibration_summary = mm_summ,
               pch = 19,
               color_pch = color_reference,
               cex_pch = 2,
               transparent_pch = 70,
               lwd_bars = 15,
               cex_legend = 0.7,
               x_legend = -20
               )
dev.off()
```
             
             
## Phylo median tree as a phylogram (all branches equal length)

```{r}
# visualize median branching times:
ape::branching.times(phylo_median)
# force equal branch lengths, with root age = 1
pp <- ape::compute.brlen(phylo_median, power = 1)
# visualize the new branch lengths:
ape::branching.times(pp)
pp$edge.length
plot(pp)
ape::axisPhylo(side = 1)
# to make branch lengths proportional to a certain age we have o multiply them by that age, in this case it's the total plot_max_time
pp$edge.length <- pp$edge.length*plot_max_time 
```

Plot the tree with source chronogram ages

```{r}
svg(filename = "../figures/figure2/synth_tree_source_ages.svg",
    height = 5,
    width = 7)
datelifeplot::plot_node_ages(pp,
               title = c("Open Tree synthetic tree", "with source chronogram ages"),
               cex_title = 2,
               plot_type = "phyloch",
               time_depth = plot_max_time,
               pos_axis = 2,
               edge.width = 2,
               cex_tiplabels = 2,
               calibration_summary = calib_summ,
               pch = 19,
               color_pch = color_studies,
               cex_pch = 2,
               lwd_bars = 15,
               cex_legend = 0.7,
               x_legend = -20,
               transparent_pch = 90
               )
dev.off()
```


