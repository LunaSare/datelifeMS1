---
title: "figure2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{figure2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Getting source chronograms

```{r setup}
# library(datelifeMS1)
devtools::load_all("../../datelifeplot")
devtools::load_all()
frin_sample_dsumm$phylo_median
spp <- frin_sample_dsumm$phylo_median$tip.label[1:6]
spp_dq <- datelife::make_datelife_query(spp)
spp_dr <- datelife::get_datelife_result(spp_dq)
spp_summ <- datelife:::summary.datelifeResult(datelife_query = spp_dq, object = spp_dr)
phylo_median <- spp_summ$phylo_median
phylo_all <- spp_summ$phylo_all
names(phylo_all)
alphabetic_order <- order(names(phylo_all))
names(phylo_all)[alphabetic_order]
phylo_all <- phylo_all[alphabetic_order]
```

We will rename source chronograms to have a shorter study name:

```{r}
names(phylo_all) <- c("Barker et al. 2013",
                      "Barker et al. 2015 - chronogram 1",
                      "Barker et al. 2015 - chronogram 2",
                      "Burns et al. 2014",
                      "Hedges et al. 2015 - chronogram 1",
                      "Hedges et al. 2015 - chronogram 2",
                      "Hooper et al. 2017",
                      "Jetz et al. 2012 - chronogram 1",
                      "Jetz et al. 2012 - chronogram 2")
```

### Plotting chronograms

Plot one chronogram as test.

Create settings and try classic `ape::plot.phylo`:

```{r}
plot_max_time <- 45
chronogram <- phylo_all[[1]]
chronogram$root.edge <- plot_max_time - max(ape::branching.times(chronogram))

ape::plot.phylo(chronogram,
                cex = 1, #edge.width = 2,
                label.offset = 0.5,
                x.lim = c(0, plot_max_time),
                root.edge = TRUE,
                plot = TRUE, edge.width = 2)
ape::axisPhylo(line = 1)
```

Plot with `datelifeplot`:
```{r}
datelifeplot::plot_phylo(chronogram,
                         title = names(phylo_all)[1],
                         plot_type = "phyloch",
                         time_depth = plot_max_time,
                         write = "pdf",
                         file_name = "../figures/figure2/test.pdf",
                         cex_tiplabels = 2,
                         cex_axislabel = 1.5,
                         cex_title = 2,
                         pos_title = 2.2,
                         pos_axis = 2)
```
[!Source chronogram test]("../figures/figure2/test.pdf")


### Plotting ALL source chronograms

We know that chronogram 9 has the oldest ages.
Get the maximum age:
```{r}
max(ape::branching.times(phylo_all[[9]]))  # 44.29586
plot_max_time <- 45
```
Another way of getting oldest age of all trees in a `multiPhylo ` object:

```{r}
max(unlist(lapply(phylo_all, ape::branching.times)))
```

Plot as pdf:

```{r}
datelifeplot::plot_phylo_all(chronograms = phylo_all,
                             folder_name = "../figures/figure2/source_phylo_all",
                             plot_height = 440,
                             plot_width = 600,
                             mai1 = 1,
                             mai2 = 0,
                             mai3 = 1,
                             mai4 = 3.72,
                             omi1 = 1,
                             omi2 = 0,
                             omi3 = 0,
                             omi4 = 0,
                             write = "pdf",
                             plot_type = "phyloch",
                             max_depth = plot_max_time,
                             edge.width = 2,
                             cex_tiplabels = 2,
                             cex_axislabel = 1.5,
                             cex_axis = 2,
                             cex_title = 2.5,
                             pos_title = -2.8,
                             pos_axis = 2,
                             axis_label = "")
```


I combined source chronogram plots with ppt (files in figures/figure2/source_phylo_all*.pptx), because combining with `magick` was not
doing what I needed. This is the code I tried:

```
for (i in seq(phylo_all)) {
  ii <- magick::image_read(path = paste0("phylo_all/phylo_all_", i, ".pdf"))
  assign(x = paste0("phy", i), value = ii)
}
img <- c(phy1, phy2, phy3, phy4, phy5, phy6, phy7, phy8, phy9)
img <- magick::image_scale(img, "300x")
magick::image_info(img)

pdf("stacked.pdf")
magick::image_append(magick::image_scale(img, "200x"))
dev.off()
```

## Get calibrations

Get calibrations:

```{r}
all_calibrations <- datelife::extract_calibrations_phylo(
  input = phylo_all,
  each = FALSE)
matched <- datelife::match_all_calibrations(
  phy = phylo_median, 
  calibrations = all_calibrations)
calib_summ <- datelife:::summary.matchedCalibrations(
  matched$matched_calibrations)

```
Plot ages from source chronograms.
Choose a color scheme for the studies:

```{r}
# Get references in matched calibrations:
studies <- as.character(unique(calib_summ$in_phy$reference))
studies

# order references alphabetically:
studies <- studies[order(studies)]
#create a vector of colors with study names:
color_studies <- viridis::turbo(n = length(studies))
names(color_studies) <- studies
```

Now, we can plot:

```{r}
svg(filename = "../figures/figure2/node_ages_matched.svg",
    height = 10,
    width = 7)
datelifeplot::plot_node_ages(phylo_median,
               title = "Median Summary Chronogram",
               plot_type = "phyloch",
               time_depth = plot_max_time,
               calibration_summary = calib_summ,
               pch = 19,
               color_pch = color_studies,
               cex_pch = 2,
               lwd_bars = 15,
               cex_legend = 0.7,
               x_legend = 2,
               y_legend = 6,
               mai1 = 1, 
               mai2 = 0,
               mai3 = 0.5,
               mai4 = 3.73,
               omi1 = 2,
               omi2 = 0,
               omi3 = 0.5,
               omi4 = 0,
               edge.width = 2,
               cex_tiplabels = 2,
               cex_axislabel = 1.5,
               cex_axis = 2,
               cex_title = 2,
               pos_title = -1,
               pos_axis = 2
               )
dev.off()
```
## Get pairwise median age points

```{r}

names(spp_dr)
spp_dr[[1]]

best_grove <- datelife::get_best_grove(spp_dr)

median_matrix <- datelife::datelife_result_median_matrix(best_grove$best_grove)
colnames(median_matrix)

median_matrix_list <- list(summary_matrix = median_matrix)

median_matrix_table <- datelife::matrices_to_table(median_matrix_list)

matched_median_ages <- datelife::match_all_calibrations(phy = spp_summ$phylo_median, calibrations = median_matrix_table)

mm_summ <- datelife:::summary.matchedCalibrations(matched_median_ages$matched_calibrations)

mm_summ$in_phy
```
Table, make it pretty:

```{r}
colnames(mm_summ$in_phy)
pretty <- mm_summ$in_phy[,c("taxonA", "taxonB", "nodeAge", "mrca_node_number")]
pretty
# Eliminate duplicated taxon pairs:
## Find the duplicated pairs
taxon_pairs <- c()
for (i in seq(nrow(pretty))) {
  taxon_pair <- as.character(pretty[i, c("taxonA", "taxonB")])
  taxon_pair <- taxon_pair[order(taxon_pair)]
  taxon_pair <- paste(taxon_pair, collapse = "")
  taxon_pairs <- c(taxon_pairs, taxon_pair)
}
## Eliminate them:
pretty <- pretty[!duplicated(taxon_pairs),]

# Reorder ROWS by node number and taxon names
pretty <- pretty[order(pretty$mrca_node_number, pretty$taxonA, pretty$taxonB),]
# Eliminate rownames
rownames(pretty) <- NULL
# Reorder COLUMNS
pretty <- pretty[, c("mrca_node_number", "taxonA", "taxonB", "nodeAge")]
# Modify column names to be informative
colnames(pretty) <- c("Node Name", "taxon A", "taxon B", "Median Age")
# Change node numbers my node names
pretty$`Node Name` <- paste0("n", pretty$`Node Name`-6)

# substitute underscore by space:

pretty$`taxon A` <- sub("_", " ", pretty$`taxon A`)
pretty$`taxon B` <- sub("_", " ", pretty$`taxon B`)


# Print table as pdf
## set the theme to have italics in species names:

tt1 <- gridExtra::ttheme_default(core=list(fg_params=list(fontface=c(rep("plain", 15), rep("italic", 30), rep("plain", 15)))))

pdf("../figures/figure2/median_table.pdf")       # Export PDF
gridExtra::grid.table(pretty, theme = tt1) # if you do not want row numbers set rows = NULL
dev.off()
```
             
Plotting source ages AND summary ages on the same dated tree

Set colors and data

```{r}
mm_summ$in_phy$reference <- rep("Median Ages", length(mm_summ$in_phy$reference))

color_median <- "purple" # mustard yellow "#7A0403FF"
names(color_median) <- mm_summ$in_phy$reference[1]

point_colors <- list(a1 = color_studies, a2 = color_median)
all_ages <- list(a1 = calib_summ, a2 = mm_summ)
point_type <- list(a1 = "/", a2 = "•")

leg_color<- c(color_studies, color_median)
# leg_pch <- c(rep("|", length(color_studies)), "•")
leg_pch <- rep(19, length(leg_color))
leg_text <- names(leg_color)

```

Plot

```{r}
svg(filename = "../figures/figure2/median_and_calibration_ages.svg",
    height = 8.5 ,
    width = 10.5)
datelifeplot::plot_node_ages2(phylo_median,
               title = c("Median Summary Chronogram"),
               pos_title = 3,
               cex_title = 2,
               plot_type = "phyloch",
               time_depth = plot_max_time,
               pos_axis = 2,
               cex_axis = 1.5,
               edge.width = 3,
               cex_tiplabels = 2,
               matched_ages  = all_ages,
               pch = point_type,
               pch_color = point_colors,
               pch_cex = 3,
               bars_lwd = 15,
               legend_cex = 0.9,
               legend_x = -5,
               legend_y = 6.2,
               legend_text = leg_text,
               legend_pch = leg_pch,
               legend_color = leg_color,
               mai1 = 1,
               mai2 = 0.8,
               mai4 = 3.6,
               axis_label = ""
               )
dev.off()
```             
Get phylo median tree as a topology (all branches of equal length)

```{r}
# visualize median branching times:
ape::branching.times(phylo_median)
# force equal branch lengths, with root age = 1
pp <- ape::compute.brlen(phylo_median, power = 1)
# visualize the new branch lengths:
ape::branching.times(pp)
pp$edge.length
plot(pp)
ape::axisPhylo(side = 1)
# to make branch lengths proportional to a certain age we have o multiply them by that age, in this case it's the total plot_max_time
pp$edge.length <- pp$edge.length*plot_max_time 
```


Plot median tree topology with node labels and no time axis

```{r}
svg(filename = "../figures/figure2/median_tree_topology.svg",
    height = 5,
    width = 7,
    bg = "transparent")
datelifeplot::plot_chronogram(pp,
                         title = c("Tree topology"),
                         time_axis = FALSE,
                         axis_label = "",
                         edge.width = 3,
                         cex_tiplabels = 2,
                         cex_axislabel = 1.5,
                         cex_axis = 2,
                         cex_title = 2,
                         pos_title = 3,
                         mai4 = 3.6)
ape::nodelabels(text = pp$node.label, frame = "circle", bg = "white", cex = 1.5)
dev.off()
```


