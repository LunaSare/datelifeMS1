---
title: "figure2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{figure2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Getting source chronograms

```{r setup}
# library(datelifeMS1)
devtools::load_all("../../datelifeplot")
devtools::load_all()
frin_sample_dsumm$phylo_median
spp <- frin_sample_dsumm$phylo_median$tip.label[1:6]
spp_dq <- datelife::make_datelife_query(spp)
spp_dr <- datelife::get_datelife_result(spp_dq)
spp_summ <- datelife:::summary.datelifeResult(datelife_query = spp_dq, object = spp_dr)
spp_summ$phylo_all

mock_spp_names <- gsub(" ", "_", spp_summ$phylo_median$tip.label)
names(mock_spp_names) <- LETTERS[1:6]
mock_spp_names

mock_study_names <- names(spp_summ$phylo_all)
iis <- match(mock_study_names, unique(mock_study_names))
names(mock_study_names) <- paste("Study", iis)
names(mock_study_names)
ffs <- table(names(mock_study_names))

is_dupl <- names(mock_study_names) %in% names(ffs)[ffs > 1]

# Add "Chronogram X" to duplicated studies:

for (i in names(ffs)[ffs > 1]) {
  dds <- i == names(mock_study_names)
  chrono_names <- paste("- Chronogram", seq(ffs[[i]]))
  names(mock_study_names)[dds] <- paste(names(mock_study_names)[dds],chrono_names )
}
```

### Rename source chronograms:

```{r}
phylo_all_renamed <- c()
for (phy in spp_summ$phylo_all){
  is_in_tree <- match(gsub(" ", "_", phy$tip.label), mock_spp_names)
  # print(is_in_tree)
  # print(phy$tip.label)
  # print(names(mock_spp_names)[is_in_tree])
  phy$tip.label <- names(mock_spp_names)[is_in_tree]
  phylo_all_renamed <- c(phylo_all_renamed, list(phy))
}
class(phylo_all_renamed) <- "multiPhylo"
names(phylo_all_renamed) <- names(mock_study_names)
```

### Plotting chronograms

Plot one chronogram as test:

```{r}
time_depth <- 45
chronogram <- phylo_all_renamed[[1]]
chronogram$root.edge <- time_depth - max(ape::branching.times(chronogram))

ape::plot.phylo(chronogram,
                cex = 1, #edge.width = 2,
                label.offset = 0.5,
                x.lim = c(0, time_depth),
                root.edge = TRUE,
                plot = TRUE, edge.width = 2)
ape::axisPhylo(line = 1)

datelifeplot::plot_phylo(chronogram,
                         title = names(phylo_all_renamed)[1],
                         plot_type = "ape",
                         time_depth = 45,
                         write = "pdf",
                         file_name = "test.pdf",
                         cex_tiplabels = 2,
                         cex_axislabel = 1.5,
                         cex_title = 2,
                         pos_title = 2.2,
                         pos_axis = 2)
```


### Plotting ALL source chronograms


```{r}
# as png, but resolution is not good and it is hard to fix within plot_phylo
# png plots are in vignettes/phylo_all/png
datelifeplot::plot_phylo_all(trees = phylo_all_renamed,
                             write = "png")

# as pdf:
max(ape::branching.times(phylo_all_renamed[[9]]))  # 44.29586

devtools::load_all("../datelifeplot")
datelifeplot::plot_phylo_all(chronograms = phylo_all_renamed,
                             write = "pdf",
                             plot_type = "phyloch",
                             max_depth = 45,
                             edge.width = 2,
                             cex_tiplabels = 2,
                             cex_axislabel = 1.5,
                             cex_axis = 2,
                             cex_title = 2,
                             pos_title = 2.2,
                             pos_axis = 2,
                             units = NULL)
```


I combined source chronogram plots with ppt because combining with `magick` was not
doing what I needed:

```{r}
for (i in seq(phylo_all_renamed)) {
  ii <- magick::image_read(path = paste0("phylo_all/phylo_all_", i, ".pdf"))
  assign(x = paste0("phy", i), value = ii)
}
img <- c(phy1, phy2, phy3, phy4, phy5, phy6, phy7, phy8, phy9)
img <- magick::image_scale(img, "300x")
magick::image_info(img)

pdf("stacked.pdf")
magick::image_append(magick::image_scale(img, "200x"))
dev.off()
```

## Get calibrations

Rename median chronogram tip labels:

```{r}
phylo_median <- spp_summ$phylo_median
is_in_tree <- match(gsub(" ", "_", phylo_median$tip.label), mock_spp_names)
phylo_median$tip.label <- names(mock_spp_names)[is_in_tree]
```

Get calibrations:

```{r}
all_calibrations <- datelife::extract_calibrations_phylo(
  input = phylo_all_renamed,
  each = FALSE)
matched <- datelife::match_all_calibrations(
  phy = phylo_median, 
  calibrations = all_calibrations)
calib_summ <- datelife:::summary.matchedCalibrations(
  matched$matched_calibrations)

```
Plot ages from source chronograms:

```{r}
# Get references in matched calibrations:
studies <- as.character(unique(calib_summ$in_phy$reference))
# order references alphabetically:
studies <- studies[order(studies)]
#create a vector of colors with study names:
color_studies <- viridis::turbo(n = length(studies))
names(color_studies) <- studies


svg(filename = "../figures/figure2/node_ages_matched.svg",
    height = 5,
    width = 7)
datelifeplot::plot_node_ages(phylo_median,
               title = c("Median Summary Chronogram", "with source chronogram ages"),
               cex_title = 2,
               plot_type = "phyloch",
               time_depth = 45,
               pos_axis = 2,
               edge.width = 2,
               cex_tiplabels = 2,
               calibration_summary = calib_summ,
               pch = 19,
               color_pch = color_studies,
               cex_pch = 2,
               lwd_bars = 15,
               cex_legend = 0.7,
               x_legend = -20
               )
dev.off()
```
## Get pairwise median age points and plot them:

```{r}

names(spp_dr)
spp_dr[[1]]

best_grove <- datelife::get_best_grove(spp_dr)

median_matrix <- datelife::datelife_result_median_matrix(best_grove$best_grove)
colnames(median_matrix)

median_matrix_list <- list(summary_matrix = median_matrix)

median_matrix_table <- datelife::matrices_to_table(median_matrix_list)

matched_median_ages <- datelife::match_all_calibrations(phy = spp_summ$phylo_median, calibrations = median_matrix_table)

mm_summ <- datelife:::summary.matchedCalibrations(matched_median_ages$matched_calibrations)

mm_summ$in_phy

## rename

mm_summ$in_phy$taxonA

is_in_taxonA <- match(gsub(" ", "_", mm_summ$in_phy$taxonA), mock_spp_names)
mm_summ$in_phy$taxonA <- names(mock_spp_names)[is_in_taxonA]

is_in_taxonB <- match(gsub(" ", "_", mm_summ$in_phy$taxonB), mock_spp_names)
mm_summ$in_phy$taxonB <- names(mock_spp_names)[is_in_taxonB]

mm_summ$in_phy$reference <- rep("Used as calibration", nrow(mm_summ$in_phy))

AB <- mm_summ$in_phy$taxonA %in% c("A", "B") & mm_summ$in_phy$taxonB %in% c("A", "B")

AC <- mm_summ$in_phy$taxonA %in% c("A", "C") & mm_summ$in_phy$taxonB %in% c("A", "C")

not_used <- AB | AC

mm_summ$in_phy[not_used,]

mm_summ$in_phy[not_used,]$reference <- rep("Excluded from analysis", 4)
```



```{r}
# We have two variables, median ages "used" as calibrations, and median ages "not used" or "excluded from analysis".
color_reference <- viridis::viridis(2) 
# c("blue", "gray")
names(color_reference) <- c("Used as calibration", "Excluded from analysis")
datelifeplot::plot_node_ages(phylo_median,
               title = c("Median Summary Chronogram", "with median pairwise ages"),
               plot_type = "phyloch",
               time_depth = 45,
               pos_axis = 2,
               edge.width = 2,
               calibration_summary = mm_summ,
               pch = 19,
               color_pch = color_reference,
               transparent_pch = 70,
               add_legend = TRUE,
               cex_legend = 0.5
               )

svg(filename = "../figures/figure2/median_ages.svg",
    height = 5,
    width = 7)
datelifeplot::plot_node_ages(phylo_median,
               title = c("Median Summary Chronogram", "with median pairwise ages"),
               cex_title = 2,
               plot_type = "phyloch",
               time_depth = 45,
               pos_axis = 2,
               edge.width = 2,
               cex_tiplabels = 2,
               calibration_summary = mm_summ,
               pch = 19,
               color_pch = color_reference,
               cex_pch = 2,
               transparent_pch = 70,
               lwd_bars = 15,
               cex_legend = 0.7,
               x_legend = -20
               )
dev.off()
```
             
             

##
